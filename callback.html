<!doctype html>
<meta charset="utf-8">
<title>TikTok OAuth JSON</title>
<meta name="robots" content="noindex">
<script>
(function () {
  // ===== Optional config (leave empty if you don't need it) =====
  const EXCHANGE_URL = ""; // e.g. "http://localhost:8080/oauth/tiktok/exchange"
  const EXPECTED_STATE = sessionStorage.getItem("oauth_state") || null;
  // =============================================================

  const url = new URL(location.href);
  const q = new URLSearchParams(location.search);
  const h = new URLSearchParams(location.hash.replace(/^#/, ""));

  const get = k => q.get(k) || h.get(k) || "";
  const code = get("code");
  const state = get("state");
  const error = get("error");
  const error_description = get("error_description");
  const ok = !!code && !error;

  const payload = {
    provider: "tiktok",
    ok,
    code,
    state,
    error,
    error_description,
    redirect_uri: location.origin + location.pathname,
    received_at: new Date().toISOString(),
    state_match: EXPECTED_STATE ? (state === EXPECTED_STATE) : null
  };

  // Try to notify an opener (popup flow)
  try {
    if (window.opener && typeof window.opener.postMessage === "function") {
      window.opener.postMessage({ type: "oauth_result", payload }, "*");
    }
  } catch (_) {}

  // Optionally ping your backend to exchange code -> tokens
  if (EXCHANGE_URL && code) {
    fetch(EXCHANGE_URL, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({
        provider: "tiktok",
        code,
        state,
        redirect_uri: payload.redirect_uri
      }),
      credentials: "omit"
    }).catch(() => {});
  }

  // Render pure JSON in the body (easy for your app to parse as text)
  // Note: as a static page the server sets Content-Type to text/html,
  // but the body is valid JSON.
  const json = JSON.stringify(payload, null, 2)
    .replace(/[<>&]/g, c => ({ "<":"&lt;", ">":"&gt;", "&":"&amp;" }[c]));
  document.write("<pre style='margin:0;padding:1rem;font:14px/1.5 monospace;'>" + json + "</pre>");
  document.close();
})();
</script>
